# ü§ñ WhatsApp Bot –¥–ª—è 360dialog

–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π WhatsApp –±–æ—Ç –Ω–∞ Python –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ API 360dialog.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
bot whats app/
‚îú‚îÄ‚îÄ bot.py                  # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª - –∑–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ config.py               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ .env
‚îú‚îÄ‚îÄ webhook.py              # –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç 360dialog
‚îú‚îÄ‚îÄ menu_handlers.py        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ –º–µ–Ω—é
‚îú‚îÄ‚îÄ requirements.txt        # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ env.example            # –ü—Ä–∏–º–µ—Ä .env —Ñ–∞–π–ª–∞
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ state.py           # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FSM)
‚îÇ   ‚îú‚îÄ‚îÄ api_360.py         # API –∫–ª–∏–µ–Ω—Ç –¥–ª—è 360dialog
‚îÇ   ‚îî‚îÄ‚îÄ sheets.py          # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets (TODO)
‚îî‚îÄ‚îÄ README.md              # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `env.example` –≤ `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:

```bash
cp env.example .env
```

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `D360_API_KEY` - API –∫–ª—é—á –æ—Ç 360dialog
- `VERIFY_TOKEN` - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è webhook
- `ADMIN_IDS` - –Ω–æ–º–µ—Ä–∞ –∞–¥–º–∏–Ω–æ–≤ (—Ñ–æ—Ä–º–∞—Ç: 79991234567)

### 3. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
python bot.py
```

–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ `http://0.0.0.0:8000`

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –≤ 360dialog

–í –ø–∞–Ω–µ–ª–∏ 360dialog (hub.360dialog.com):
- **Webhook URL**: `https://–≤–∞—à-–¥–æ–º–µ–Ω.com/webhook`
- **Verify Token**: –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `.env`

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok:
```bash
ngrok http 8000
```

## üì° API Endpoints

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|
| `/` | GET | –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã) |
| `/webhook` | GET | –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è webhook |
| `/webhook` | POST | –ü—Ä–∏—ë–º —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç 360dialog |
| `/health` | GET | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–µ—Ä–∞ |

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### bot.py
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª, –∑–∞–ø—É—Å–∫–∞–µ—Ç Flask —Å–µ—Ä–≤–µ—Ä –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ endpoints.

### config.py
–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ `.env` —Ñ–∞–π–ª–∞:
- API –∫–ª—é—á–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤
- –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º

### webhook.py
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç 360dialog:
- `GET /webhook` - –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
- `POST /webhook` - –ø—Ä–∏—ë–º —Å–æ–æ–±—â–µ–Ω–∏–π

### menu_handlers.py
–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞:
- `handle_incoming_message()` - –≥–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä
- `handle_text_message()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
- `handle_button_click()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
- `handle_main_menu()` - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- `handle_shift_menu()` - –º–µ–Ω—é —Å–º–µ–Ω
- `handle_stats_menu()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### utils/state.py
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FSM):
- `get_user_state()` - –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- `set_user_state()` - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- `clear_user_state()` - –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### utils/api_360.py
API –∫–ª–∏–µ–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:
- `send_text_message()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
- `send_buttons()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–Ω–æ–ø–æ–∫ (–¥–æ 3 —à—Ç)
- `send_list_message()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–∏—Å–∫–∞

### utils/sheets.py
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets (–∑–∞–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏).

## üîß –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –≤ `menu_handlers.py`:
```python
def handle_my_menu(user_id: str):
    text = "–ú–æ–µ –º–µ–Ω—é"
    buttons = [
        {"id": "action_1", "title": "–î–µ–π—Å—Ç–≤–∏–µ 1"},
        {"id": "main_menu", "title": "üîô –ù–∞–∑–∞–¥"}
    ]
    send_buttons(user_id, text, buttons)
```

2. –î–æ–±–∞–≤—å—Ç–µ —Ä–æ—É—Ç–∏–Ω–≥ –≤ `handle_button_click()`:
```python
elif button_id == 'my_menu':
    handle_my_menu(user_id)
```

### FSM (–ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π)

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π:

```python
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
set_user_state(user_id, "waiting_name")

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
state = get_user_state(user_id)
if state.get("state") == "waiting_name":
    # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–≤–æ–¥ –∏–º–µ–Ω–∏
    pass

# –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
clear_user_state(user_id)
```

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤:
- `bot.log` - —Ñ–∞–π–ª —Å –ª–æ–≥–∞–º–∏
- –∫–æ–Ω—Å–æ–ª—å - –≤—ã–≤–æ–¥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
- `INFO` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- `WARNING` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- `ERROR` - –æ—à–∏–±–∫–∏

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ webhook
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–æ–≤
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- ‚ö†Ô∏è –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` –≤ Git

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞
```bash
curl http://localhost:8000/health
```

### –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
```python
from utils.api_360 import send_text_message
send_text_message("79991234567", "–¢–µ—Å—Ç")
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π
```python
from utils.state import get_all_states
print(get_all_states())
```

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [360dialog Documentation](https://docs.360dialog.com/)
- [WhatsApp Business API](https://developers.facebook.com/docs/whatsapp)
- [Flask Documentation](https://flask.palletsprojects.com/)

## üí° TODO

- [ ] –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (SQLite/PostgreSQL)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Google Sheets –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License

